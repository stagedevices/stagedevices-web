<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script>
      (() => {
        const steps = [0, 51, 102, 153, 204, 255];
        const storageKey = "sd_nextAccent";

        const toHex = (v) => v.toString(16).padStart(2, "0").toUpperCase();
        const rgbToHex = (rgb) => `#${toHex(rgb[0])}${toHex(rgb[1])}${toHex(rgb[2])}`;

        const srgbToLin = (c255) => {
          const c = c255 / 255;
          return c <= 0.04045 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
        };

        const relLuminance = ([r, g, b]) => {
          const R = srgbToLin(r);
          const G = srgbToLin(g);
          const B = srgbToLin(b);
          return 0.2126 * R + 0.7152 * G + 0.0722 * B;
        };

        const isWebSafe = (rgb) => rgb.every((v) => steps.includes(v));

        const isValidAccent = (rgb) => {
          if (!rgb || rgb.length !== 3) return false;
          if (!isWebSafe(rgb)) return false;

          const max = Math.max(...rgb);
          const min = Math.min(...rgb);

          // Reject low-chroma / grayish
          if (max - min < 153) return false;

          // Keep accents dark enough to read on white (avoid pastels)
          const L = relLuminance(rgb);
          if (L > 0.28) return false;

          // Avoid near-black “dead” accents
          if (L < 0.07) return false;

          return true;
        };

        const parseHex = (value) => {
          if (!value || !/^#?[0-9A-Fa-f]{6}$/.test(value)) return null;
          const hex = value.startsWith("#") ? value.slice(1) : value;
          const rgb = [
            parseInt(hex.slice(0, 2), 16),
            parseInt(hex.slice(2, 4), 16),
            parseInt(hex.slice(4, 6), 16),
          ];
          return isValidAccent(rgb) ? rgb : null;
        };

        const randomAccent = () => {
          for (let i = 0; i < 600; i += 1) {
            const rgb = [
              steps[(Math.random() * steps.length) | 0],
              steps[(Math.random() * steps.length) | 0],
              steps[(Math.random() * steps.length) | 0],
            ];
            if (isValidAccent(rgb)) return rgb;
          }
          return [204, 0, 153];
        };

        const current = parseHex(localStorage.getItem(storageKey)) || randomAccent();
        document.documentElement.style.setProperty("--accent", rgbToHex(current));

        const next = randomAccent();
        localStorage.setItem(storageKey, rgbToHex(next));
      })();
    </script>

    <title>Stage Devices</title>
    <meta name="description" content="Artist-run engineering practice building performance tools: SyncTimer and Tenney." />
  </head>
  <body>
    <div id="page">
      <div id="root" class="content"></div>
    </div>
    <script type="module" src="./src/main.tsx"></script>
  </body>
</html>
